## 私有部署

爱速搭支持私有部署，您可以部署在自己的内网，私有部署版本具备 SaaS 版本的所有功能。

### 环境需求

需要您的机器安装`Docker`，推荐版本为`18.09`及以上，爱速搭可以运行在单机 Docker 环境上，如果需要集群化、高可用，可以使用 Docker 自带的 swarm 或者 k8s。

Docker 的安装建议参考官方文档，可以安装在[Centos](https://docs.docker.com/install/linux/docker-ce/centos/)、[Ubuntu](https://docs.docker.com/install/linux/docker-ce/ubuntu/)、[Windows](https://docs.docker.com/docker-for-windows/install/)、[Mac](https://docs.docker.com/docker-for-mac/install/)等系统上。

如果官网下载慢可以试试[百度网盘](https://pan.baidu.com/s/1Q7trxAv0R9TbtxkdmxUbMA)（提取码: 8cq3）。

### 单机版本

单机版本依赖 `docker-compose`，在 Mac 和 Windows 下的 Docker 程序会自带，如果是 Linux 则需要执行以下命令来安装：

```
sudo curl -L "https://github.com/docker/compose/releases/download/1.26.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

首先选择一个目录作为爱速搭的安装目录，在这个目录下创建两个空目录 `db-data` 和 `redis-data`，然后创建 `docker-compose.yml` 文件，内容是：

```
version: '3'
services:
  web:
    image: registry.baidubce.com/aisuda/aisuda:1.0.43
    restart: always
    ports:
      - '8088:8085'
    environment:
      # 数据库用户名
      ISUDA_DB_USER: suda
      # 数据库密码，这个密码需要和下面 postgres 镜像里一致
      ISUDA_DB_PASSWORD: 'Q39sTi0i^9'
      ISUDA_DB_NAME: suda
      ISUDA_DB_HOST: db
      ISUDA_DB_PORT: 5432

      # redis 地址和端口
      ISUDA_REDIS_HOST: redis
      ISUDA_REDIS_PORT: 6379

      # 如果是 redis 集群请开启如下配置
      # ISUDA_REDIS_CLUSTER: true
      # 集群模式的机器配置，多台机器通过逗号分隔，每台机器配上地址和端口
      # ISUDA_REDIS_HOST: '127.0.0.1:6379,127.0.0.2:6379,127.0.0.3:6379'

      # 邮件 smtp 地址，用于发验证码
      ISUDA_EMAIL_HOST:
      # 邮件 smtp 端口，比如 25
      ISUDA_EMAIL_PORT:
      # 邮件用户名和密码
      ISUDA_EMAIL_USER:
      ISUDA_EMAIL_PASS:
      # 邮件显示的发件人地址
      ISUDA_EMAIL_FROM: 'xxx@xxx.com'

      # license（可选，如果不填则需要在安装时提供）
      ISUDA_LICENSE:

      # 百度统计（可选）
      BAIDU_TONGJI_CODE:

      # 文件存储配置（可选）
      # DRIVER 支持 bos 或 s3
      ISUDA_FILE_STORAGE_DRIVER:
      ISUDA_FILE_STORAGE_REGION:
      ISUDA_FILE_STORAGE_BUCKET:
      ISUDA_FILE_STORAGE_AK:
      ISUDA_FILE_STORAGE_SK:

      # 日志相关（可选）
      # 将日志输出到控制台
      # ISUDA_LOG_STDOUT: true
      # 日志等级，4 是 notice、8 还包括 trace、16 还包括 debug
      # ISUDA_LOG_LEVEL: 4

      # 其它高级设置
      # 关闭代理的过滤功能，允许向后端发送所有 header，包括 cookie
      # ISUDA_DISABLE_PROXY_FILTER: true

  db:
    image: postgres:12
    restart: always
    command: postgres -c 'max_connections=2048' -c 'shared_buffers=128MB'
    ports:
      - '5432:5432'
    volumes:
      - ./db-data:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: suda
      POSTGRES_PASSWORD: 'Q39sTi0i^9'

  redis:
    image: redis:5
    restart: always
    ports:
      - '6379:6379'
    command: ['redis-server', '--appendonly', 'yes']
    volumes:
      - ./redis-data:/data
```

建议修改其中的 `POSTGRES_PASSWORD`。

创建完文件后使用 `docker-compose up` 命令来尝试启动，如果没问题，访问 http://localhost:8088/ 可以看到安装界面。

如果确认没问题，可以用 ctrl+c 关闭，然后使用 `docker-compose up -d` 来后台持续运行。

### 申请 license

目前只支持申请试用版本 License，请前往[百度云爱速搭控制台](https://console.bce.baidu.com/suda/), 点击「申请私有版 License」按钮即可免费获得。试用 License 可以使用一个月。

获得 License 后可通过环境变量设置，也可以在安装界面设置。

### 如何在无网环境安装？

首先是 Docker，Windows 和 Mac 可以通过上面的安装包离线安装，而 Linux 需要[参考这里](https://docs.docker.com/engine/install/binaries/#install-daemon-and-client-binaries-on-linux)下载二进制文件来安装。

接下来需要将镜像也保存为文件，方法是找一台能联网且有 Docker 的机器，运行如下命令：

```
docker pull registry.baidubce.com/aisuda/aisuda:1.0.43
docker save -o suda.tar registry.baidubce.com/aisuda/aisuda:1.0.43
docker save -o postgres.tar postgres:12
docker save -o redis.tar redis:5
```

将这三个文件上传到需要安装的服务器上，执行如下命令：

```
docker load -i suda.tar
docker load -i postgres.tar
docker load -i redis.tar
```

同时我们还提供了 amis 文档的内网版本，可以通过如下命令下载：

```
docker pull hub.baidubce.com/isuda/amis:20201214
docker save -o amis.tar hub.baidubce.com/isuda/amis:20201214
```

同样通过类似的 docker load -i amis.tar 命令来加载。

amis 镜像内部端口是 8888。

### 分布式版本

爱速搭支持多实例部署，但它依赖的 Redis 和 Postgres 不支持，所以要多实例必须先部署 Redis 和 Postgres，然后通过环境变量来让爱速搭去连。
